# ===============================================================
# 載入套件
# ===============================================================
library(dplyr)
library(ggplot2)
library(broom)

# ===============================================================
# 內建資料集：mtcars
# am: 變速箱 (0 = 自排, 1 = 手排)
# vs: 引擎型式 (0 = V 型, 1 = 直列)
# hp: 馬力
# wt: 車重 (1000 lbs)
# 我們假設 am=1 (手排) 的車代表「已投保」，am=0 代表「未投保」
# ===============================================================

data(mtcars)
df <- mtcars %>%
  mutate(
    Insured = ifelse(am == 1, 1, 0),             # 模擬投保狀態
    Engine  = factor(vs, labels = c("V型", "直列"))
  )

# ===============================================================
# 一、邏輯迴歸簡介
# ===============================================================
# 邏輯迴歸用於二元因變數 (0/1)，模型形式為：
# log(p / (1-p)) = β0 + β1x1 + ... + βnxn
# 其中 p 為事件 (Insured=1) 的機率
# family = "binomial" 用於指定二元 logistic regression

# ===============================================================
# 二、單變數邏輯迴歸
# ===============================================================
fit1 <- glm(Insured ~ Engine, data = df, family = "binomial")
summary(fit1)

# 係數解讀：
# (Intercept) 是基準組的 log-odds
# Engine直列 是與基準組 (V型) 相比的 log-odds 差異
# p 值檢定該係數是否顯著

# ===============================================================
# 三、多變數邏輯迴歸
# ===============================================================
fit2 <- glm(Insured ~ Engine + hp + wt, data = df, family = "binomial")
summary(fit2)

# 解讀：
# - Engine直列: 控制馬力與車重後，直列引擎 vs V 型引擎的投保機率差異
# - hp: 每增加 1 單位馬力，投保的 log-odds 改變多少
# - wt: 車重每增加 1 (1000 lbs)，投保的 log-odds 改變多少

# ===============================================================
# 四、比值比 (Odds Ratio) 與信賴區間
# ===============================================================
exp(cbind(OR = coef(fit2), confint(fit2)))

# ===============================================================
# 五、模型視覺化 (以馬力為例)
# ===============================================================
ggplot(df, aes(x = hp, y = Insured)) +
  geom_jitter(height = 0.05, width = 0) +
  stat_smooth(method = "glm", method.args = list(family = "binomial"), se = TRUE) +
  labs(title = "Logistic Regression: 投保狀態 vs 馬力",
       x = "馬力", y = "投保機率")
