# ===============================================================
# 載入套件
# ===============================================================
library(dplyr)
library(ggplot2)
library(broom) # 用於整理模型輸出

# ===============================================================
# 內建資料集：mtcars
# mpg: 油耗 (Miles per gallon)
# wt : 車重 (1000 lbs)
# hp : 馬力
# am : 變速箱 (0 = 自排, 1 = 手排)
# ===============================================================

data(mtcars)
mtcars2 <- as_tibble(mtcars) %>%
  mutate(am = factor(am, labels = c("automatic", "manual")))

# ===============================================================
# 一、簡單線性迴歸 (單一自變數)
# mpg ~ wt (油耗與車重關係)
# ===============================================================

fit1 <- lm(mpg ~ wt, data = mtcars2)
summary(fit1)

# 解讀：
# (Intercept) = 截距 → 車重為 0 時的預測油耗 (理論值)
# wt 係數      → 車重每增加 1 (1000 lbs)，油耗平均下降多少
# p 值         → 判斷該變數是否顯著影響油耗

# 視覺化
ggplot(mtcars2, aes(x = wt, y = mpg)) +
  geom_point() +
  geom_smooth(method = "lm") +
  labs(title = "Linear regression: MPG ~ Weight",
       x = "Weight (1000 lbs)", y = "MPG")

# ===============================================================
# 二、與 t 檢定比較 (類別變數情境)
# mpg ~ am
# ===============================================================

# t 檢定
t.test(mpg ~ am, data = mtcars2, var.equal = TRUE)

# 等價的線性模型
fit2 <- lm(mpg ~ am, data = mtcars2)
summary(fit2)
anova(fit2)

# 驗證 t 值平方 = F 值
t_val <- summary(fit2)$coefficients[2, "t value"]
f_val <- anova(fit2)$"F value"[1]
t_val^2; f_val

# ===============================================================
# 三、多元線性迴歸
# mpg ~ am + wt + hp
# 同時考慮變速箱類型、車重、馬力
# ===============================================================

fit3 <- lm(mpg ~ am + wt + hp, data = mtcars2)
summary(fit3)

# 係數解讀：
# - ammanual: 控制車重與馬力後，手排車平均油耗差異
# - wt: 控制其他變數後，車重對油耗的邊際影響
# - hp: 控制其他變數後，馬力對油耗的邊際影響

# ===============================================================
# 四、ANOVA 與 lm 關係
# ===============================================================
# ANOVA = 比較多組平均數的線性模型
# 單因子情況下，ANOVA 與 t 檢定等價
anova(lm(mpg ~ factor(cyl), data = mtcars2))

# ===============================================================
# 五、重要提醒
# ===============================================================
# 1) t 檢定、ANOVA 都是線性模型的特例
# 2) 線性模型可同時處理類別與連續自變數
# 3) 切勿將線性模型外推到訓練資料範圍以外
